generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String
  role         UserRole
  isActive     Boolean  @default(true)
  companyId    String?
  storeId      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  company      Company? @relation(fields: [companyId], references: [id])
  store        Store?   @relation(fields: [storeId], references: [id])

  @@index([companyId])
  @@index([storeId])
}

model Company {
  id               String           @id @default(cuid())
  name             String
  taxId            String           @unique
  email            String
  phone            String
  address          String?
  isActive         Boolean          @default(true)
  billingFrequency BillingFrequency @default(DAILY)
  commissionRate   Float            @default(0.05)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  invoices         Invoice[]
  stores           Store[]
  users            User[]
}

model Store {
  id               String            @id @default(cuid())
  name             String
  code             String            @unique
  address          String
  phone            String
  isActive         Boolean           @default(true)
  companyId        String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  authorizedPhones AuthorizedPhone[]
  cards            Card[]
  activations      CardActivation[]
  InvoiceItem      InvoiceItem[]
  company          Company           @relation(fields: [companyId], references: [id])
  users            User[]

  @@index([companyId])
}

model AuthorizedPhone {
  id        String   @id @default(cuid())
  phone     String
  storeId   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([phone, storeId])
  @@index([storeId])
}

model Product {
  id            String                @id @default(cuid())
  name          String
  sku           String                @unique
  brand         String
  category      String?
  imageUrl      String?
  isActive      Boolean               @default(true)
  isGiftCard    Boolean               @default(false)
  minAmount     Float?
  maxAmount     Float?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  cards         Card[]
  keys          Key[]
  denominations ProductDenomination[]
}

model ProductDenomination {
  id        String   @id @default(cuid())
  amount    Float
  currency  String   @default("USD")
  productId String
  createdAt DateTime @default(now())
  cards     Card[]
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, amount])
  @@index([productId])
}

model CardBatch {
  id           String   @id @default(cuid())
  code         String   @unique
  description  String?
  manufacturer String?
  currency     String   @default("COP")
  totalCards   Int
  totalCost    Float
  producedAt   DateTime @default(now())
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  cards        Card[]
}

model Key {
  id            String    @id @default(cuid())
  code          String    @unique
  productId     String
  isVerified    Boolean   @default(false)
  transactionId String?
  expiresAt     DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  card          Card?
  product       Product   @relation(fields: [productId], references: [id])

  @@index([productId])
}

model Card {
  id                  String               @id @default(cuid())
  uuid                String               @unique
  qrData              String
  productId           String
  denominationId      String?
  customAmount        Float?
  storeId             String
  isActivated         Boolean              @default(false)
  isRedeemed          Boolean              @default(false)
  activatedAt         DateTime?
  redeemedAt          DateTime?
  scanCount           Int                  @default(0)
  maxScans            Int                  @default(5)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  batchId             String?
  fabricationUnitCost Float?
  keyId               String?              @unique
  batch               CardBatch?           @relation(fields: [batchId], references: [id])
  denomination        ProductDenomination? @relation(fields: [denominationId], references: [id])
  key                 Key?                 @relation(fields: [keyId], references: [id])
  product             Product              @relation(fields: [productId], references: [id])
  store               Store                @relation(fields: [storeId], references: [id])
  activation          CardActivation?
  invoiceItems        InvoiceItem[]
  scanLogs            ScanLog[]

  @@index([storeId])
  @@index([productId])
  @@index([isActivated])
  @@index([uuid])
  @@index([batchId])
  @@index([keyId])
}

model CardActivation {
  id                    String                  @id @default(cuid())
  cardId                String                  @unique
  storeId               String
  activatedBy           String
  activatedAt           DateTime                @default(now())
  matrixResponse        Json?
  activationAmount      Float
  billingStatus         ActivationBillingStatus @default(PENDING)
  commissionAmount      Float?
  commissionRateApplied Float?
  grossProfit           Float?
  invoiceId             String?
  otherCosts            Float?
  card                  Card                    @relation(fields: [cardId], references: [id], onDelete: Cascade)
  invoice               Invoice?                @relation(fields: [invoiceId], references: [id])
  store                 Store                   @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([activatedAt])
  @@index([billingStatus])
  @@index([invoiceId])
}

model ScanLog {
  id         String   @id @default(cuid())
  cardId     String
  wasSuccess Boolean
  reason     String?
  ipAddress  String?
  userAgent  String?
  scannedAt  DateTime @default(now())
  card       Card     @relation(fields: [cardId], references: [id], onDelete: Cascade)

  @@index([cardId])
  @@index([scannedAt])
  @@index([wasSuccess])
}

model Invoice {
  id               String           @id @default(cuid())
  invoiceNumber    String           @unique
  companyId        String
  periodStart      DateTime
  periodEnd        DateTime
  totalSales       Float
  commissionRate   Float
  commissionAmount Float
  totalAmount      Float
  status           InvoiceStatus    @default(PENDING)
  paidAt           DateTime?
  pdfUrl           String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  exchangeRate     Float?
  CardActivation   CardActivation[]
  company          Company          @relation(fields: [companyId], references: [id])
  items            InvoiceItem[]

  @@index([companyId])
  @@index([status])
  @@index([periodStart, periodEnd])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())
  storeId     String?
  cardId      String?
  card        Card?    @relation(fields: [cardId], references: [id])
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  store       Store?   @relation(fields: [storeId], references: [id])

  @@index([invoiceId])
  @@index([storeId])
  @@index([cardId])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

enum UserRole {
  SUPER_ADMIN
  SYSTEM_ADMIN
  COMPANY_ADMIN
  STORE_OPERATOR
}

enum BillingFrequency {
  DAILY
  THREE_DAYS
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum ActivationBillingStatus {
  PENDING
  INVOICED
  PAID
  CANCELLED
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}
